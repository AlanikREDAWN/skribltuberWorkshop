<!DOCTYPE html>
<html>
    <head>
        <title>Scribbletuber!</title>
        <style>
            /* .audioBar {
                background-color: #000000;
                /* overflow: hidden; */
                /* position: fixed;
                bottom: 0;
                width: 100%; */
            /* } */ 
             .idle {
                animation: idle
             }

             .talking {

             }
        </style>
    </head>
    <body>
        <h1>Hello world! Meow!</h1>
        <input type="range" id="position-slider" min="0" max="100">
        <img id="scribbletuber" src="closed.png" style="left: 0;position: relative; width: 200px;">
        <div class=""></div>
        <script>
            const positionSlider = document.getElementById('position-slider')
            const scribbletuber = document.getElementById('scribbletuber')

            // when you slide the input, move the image
            scribbletuber.style.left = `${positionSlider.value}px`
            positionSlider.addEventListener('input', () => {
                scribbletuber.style.left = `${positionSlider.value}px`
            })

            navigator.mediaDevices.getUserMedia({ audio: true })
                .then((stream) => {
                    alert('audio granted!')
                    const audio = new AudioContext()
                    const analyser = audio.createAnalyser()
                    analyser.minDecibels = -100
                    analyser.maxDecibels = 0
                    analyser.fftSize = 64 * 2 * 2 * 2 * 2
                    analyser.smoothingTimeConstant = 0.70

                    const source = audio.createMediaStreamSource(stream)
                    source.connect(analyser)
                    const array = new Uint8Array(analyser.frequencyBinCount)
                    function speak() {
                        requestAnimationFrame(speak)
                        analyser.getByteFrequencyData(array)

                        let length = 0
                        for (let i = 0; i < array.length; i++) {
                            if (array[i] > 0) {
                                length += 1
                            }
                            array[i] = (((array[i] * 100) / 255) - 100) * -1
                        }
                        const dB = Math.min(100, -Math.round(array.reduce((x, y) => x + y / array.length)) + 200)
                        
                        console.log(dB)
                        
                        if (dB < 15) {
                            scribbletuber.src = "closed.png"
                            scribbletuber.style.bottom = `${dB/10}px`
                            // scribbletuber.classList.remove('talking')
                            // scribbletuber.classList.add('idle')
                        } else if (dB < 20) {
                            scribbletuber.src = "open.png"
                            scribbletuber.style.bottom = `${dB}px`
                            // scribbletuber.classList.add('talking')
                            // scribbletuber.classList.remove('idle')
                        }
                        else {
                            // super loud
                            scribbletuber.src = "scream.png"
                            scribbletuber.style.bottom = `${dB}px`
                            // scribbletuber.classList.add('talking')
                            // scribbletuber.classList.remove('idle')
                        }
                    }
                    // })
                    // const speak = () => {
                    //     requestAnimationFrame(speak)
                    //     analyser.getByteFrequencyData(array)

                    //     let length = 0
                    //     for (let i = 0; i < array.length; i++) {
                    //         if (array[i] > 0) {
                    //             length += 1
                    //         }
                    //         array[i] = (((array[i] * 100) / 255) - 100) * -1
                    //     }
                    //     const dB = Math.min(100, -Math.round(array.reduce((x, y) => x + y / array.length)) + 200)
                    //     // console.log(dB)
                    //     scribbletuber.style.bottom = `${dB}px`
                    //     if (dB > 10) {
                    //         scribbletuber.src = 'open.jpg'
                    //         // scribbletuber.classList.remove.idle
                    //         // scribbletuber.classList.add.talking
                    //     } else {
                    //         scribbletuber.src = 'closed.jpg'
                    //         // scribbletuber.classList.add.idle
                    //         // scribbletuber.classList.remove.talking
                    //     }
                    // }
                    speak()
                })
        </script>
    </body>
</html>